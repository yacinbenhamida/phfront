<div class="main">


    <main class="content">
        <div class="container-fluid p-0">
            <!--    alert message    -->
            <div *ngIf="error" class="alert alert-danger alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <div class="alert-message">
                    <strong>Ajout echoué</strong> Veuillez réessayer ultérieurement, ou vérifiez vos champs.
                </div>
            </div>
            <!--end alert-->
            <h1 class="h3 mb-3">Utilisateurs</h1>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">                      
                            <h5 class="card-title">Ajouter un utilisateur</h5>
                            <h6 class="card-subtitle text-muted">informations générales</h6>
                        </div>
                        <div class="card-body">
                            <form #userForm="ngForm">
                                <div class="row">
                                    <div class="col-12 col-lg-6">
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>Nom</label>
                                                <input #nom="ngModel" minlength="3" maxlength="15" required
                                                    [(ngModel)]="userToAdd.nom" name="nom" type="text"
                                                    class="form-control" placeholder="foulen">
                                                <span class="msg font-11" *ngIf="nom.touched && nom.errors">nom
                                                    invalide*</span>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>prenom</label>
                                                <input #prenom="ngModel" required minlength="3" maxlength="20"
                                                    [(ngModel)]="userToAdd.prenom" name="prenom" type="text"
                                                    class="form-control" placeholder="ben foulen">
                                                <span class="msg font-11" *ngIf="prenom.touched && prenom.errors">prenom
                                                    invalide*</span>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>date de naissance</label>
                                                <input #daten="ngModel" required [(ngModel)]="userToAdd.date_naissance"
                                                    name="date_naissance" type="date" class="form-control"
                                                    placeholder="JJ/MM/AAAA">
                                                <span class="msg font-11" *ngIf="daten.touched && daten.errors">date
                                                    invalide*</span>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>n° CIN</label>
                                                <input #cin="ngModel" required [(ngModel)]="userToAdd.cin"
                                                    pattern="^[0-9]{8}" minlength="8" maxlength="8" name="cin"
                                                    type="number" class="form-control" placeholder="XXXXXXX">
                                                <span class="msg font-11" *ngIf="cin.touched && cin.errors">n° CIN
                                                    invalide*</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>adresse</label>
                                            <input type="text" [(ngModel)]="userToAdd.adresse" name="adr"
                                                class="form-control" placeholder="15 rue des jasmins">
                                        </div>
                                        <div class="form-group">
                                            <label>adresse actuelle</label>
                                            <input type="text" [(ngModel)]="userToAdd.adresse_actuelle" name="adract"
                                                class="form-control" placeholder="24 rue el attarine">
                                        </div>
                                        <div class="form-group">
                                            <label>image</label>
                                            <input type="text" [(ngModel)]="userToAdd.imageUrl" name="image"
                                                class="form-control" placeholder="http://img.png">
                                        </div>
                                        <div class="form-group">
                                            <label>diplome</label>
                                            <input type="text" [(ngModel)]="userToAdd.diplome" name="diplome"
                                                class="form-control" placeholder="License, doctorat, mastére...">
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>email personnel</label>
                                                <input #emailp="ngModel" minlength="0"
                                                    pattern="^([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5})$"
                                                    [(ngModel)]="userToAdd.emailPerso" name="emailp" type="text"
                                                    class="form-control" placeholder="foulen@farmavens.tn">
                                                <span class="msg font-11" *ngIf="emailp.touched && emailp.errors">email
                                                    invalide*</span>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>email attribué</label>
                                                <input #email="ngModel" minlength="0" type="text"
                                                    pattern="^([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5})$"
                                                    [(ngModel)]="userToAdd.email" name="email" class="form-control"
                                                    placeholder="foulen@farmavens.tn">
                                                <span class="msg font-11" *ngIf="email.touched && email.errors">email
                                                    invalide*</span>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>type de contrat</label>
                                                <select required #contrat='ngModel' [(ngModel)]="userToAdd.type_contrat"
                                                    name="contrat" class="form-control mb-3">
                                                    <option selected value="type">type</option>
                                                    <option>CDI</option>
                                                    <option>CDD</option>
                                                    <option>SIVP</option>
                                                    <option>autres</option>
                                                </select>
                                                <span class="msg font-11"
                                                    *ngIf="contrat.touched && contrat.value == 'type'">type de contrat
                                                    non choisit*</span>
                                            </div>
                                            <div class="form-group col-md-3">
                                                <label>salaire</label>
                                                <input #salaire="ngModel" minlength="1" [(ngModel)]="userToAdd.salaire"
                                                    name="salaire" type="number" class="form-control" placeholder="TND.">
                                                <span class="msg font-11"
                                                    *ngIf="(salaire.touched && salaire.errors) || (salaire.touched && salaire.value <= 0)">salaire
                                                    invalide*</span>
                                            </div>
                                            <div class="form-group col-md-3">
                                                <label>frais</label>
                                                <input #frais="ngModel" minlength="1" [(ngModel)]="userToAdd.frais"
                                                    name="frais" type="number" class="form-control" placeholder="TND.">
                                                <span class="msg font-11"
                                                    *ngIf="(frais.touched && frais.errors) || (frais.touched && frais.value <= 0)">frais
                                                    invalides*</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="form-group custom-control custom-switch">
                                                <input #vehicule="ngModel" [(ngModel)]="userToAdd.possede_vehicule"
                                                    name="vehicule" type="checkbox" class="custom-control-input"
                                                    id="customSwitch2">
                                                <label for="customSwitch2" class="custom-control-label">{{vehicule.value == true ? 'posséde une voiture' : 'ne posséde pas de voiture'}}
                                                </label>
                                            </div>
                                            <div *ngIf="vehicule.value">
                                            <div class="form-row">
                                                <div class="form-group col-md-4">
                                                    <label>modele</label>
                                                    <input #modele="ngModel" [(ngModel)]="carToAdd.modele" required="userToAdd.possede_vehicule == true"
                                                     name="modele" 
                                                    type="text" class="form-control" placeholder="Peugeot,VW...">
                                                </div>
                                            <div class="form-group col-md-4">
                                                <label>amortissement</label>
                                                <input #amortissement="ngModel" [(ngModel)]="carToAdd.amortissement_vehicule" required="userToAdd.possede_vehicule == true" min="1"
                                                 name="amortissementTND" 
                                                type="number" class="form-control" placeholder="valeur en TND.">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>kilométrage</label>
                                                <input [(ngModel)]="carToAdd.kilometrage" name="km" required="userToAdd.possede_vehicule == true" minlength="1" type="number" placeholder="km." class="form-control">
                                            </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group col-md-4">
                                                    <label>immatriculation</label>
                                                    <input name="carm" maxlength="9" [(ngModel)]="carToAdd.immatriculation" minlength="8"
                                                         type="text" class="form-control" placeholder="XXXTUXXXX">
                                                </div>
                                                <div class="form-group col-md-6">
                                                    <label>n° carte grise</label>
                                                    <input name="cg" [(ngModel)]="carToAdd.carte_grise" minlength="1"
                                                         type="text" class="form-control" placeholder="XQKLMCODSDS...">
                                                </div>
                                                </div>
                                                <div class="form-row">
                                                <div class="form-group col-md-6">
                                                    <label>date échénace assurance</label>
                                                    <input name="assurc" [(ngModel)]="carToAdd.date_echeance_assurance"  minlength="1"
                                                    type="date" class="form-control">
                                                </div>
                                                <div class="form-group col-md-6">
                                                    <label>date derniere vidange</label>
                                                    <input  name="date_derniere_vidange" [(ngModel)]="carToAdd.date_derniere_vidange"  minlength="1"
                                                    type="date" class="form-control">
                                                </div>
                                                </div>
                                                <div class="form-row">
                                                    <div class="form-group col-md-6">
                                                    <label>numero carte essence</label>
                                                    <input  name="numero_carte_essence" [(ngModel)]="carToAdd.numero_carte_essence" minlength="1"
                                                    type="text" class="form-control" placeholder="ABDCEFGH...">
                                                </div>
                                                <div class="form-group col-md-6">
                                                    <label>code carte essence</label>
                                                    <input name="code_carte_essence" [(ngModel)]="carToAdd.code_carte_essence" minlength="1"
                                                    type="password" class="form-control" placeholder="*****">
                                                </div>                         
                                                </div>
                                                </div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-lg-6">
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>Banque</label>
                                                <input #banque="ngModel" minlength="3" maxlength="25" required
                                                    [(ngModel)]="userToAdd.banque" name="banque" type="text"
                                                    class="form-control" placeholder="BIAT,attijari...">
                                                <span class="msg font-11" *ngIf="banque.touched && banque.errors">banque
                                                    invalide*</span>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>RIB banque</label>
                                                <input #rib="ngModel" required minlength="3" maxlength="20"
                                                    [(ngModel)]="userToAdd.rib_bancaire" name="rib" type="text"
                                                    class="form-control" placeholder="A41XXXXXX...">
                                                <span class="msg font-11" *ngIf="rib.touched && rib.errors">RIB
                                                    invalide*</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Matricule CNSS</label>
                                            <input required #cnss="ngModel" type="text" minlength="8"
                                                [(ngModel)]="userToAdd.matricule_cnss" name="matricule_cnss"
                                                class="form-control" placeholder="CQFGHIJ.....">
                                            <span class="msg font-11" *ngIf="cnss.touched && cnss.errors">Matricule CNSS
                                                invalide*</span>
                                        </div>
                                        <div class="form-group">
                                            <label>Mot de passe</label>
                                            <input required #mdp="ngModel" placeholder="*******" pattern="^[A-Z]+[a-zA-Z0-9]*" minlength="8"
                                                [(ngModel)]="userToAdd.password" name="pass" type="password"
                                                class="form-control">
                                            <span class="msg font-11" *ngIf="mdp.touched && mdp.errors">mot de passe
                                                faible*</span>
                                        </div>
                                        <div class="form-group">
                                            <label>confirmer le mot de passe</label>
                                            <input  placeholder="*******" required #confirmpw="ngModel" ngModel pattern="^[A-Z]+[a-zA-Z0-9]*"
                                                minlength="8" type="password" name="confirmpw" class="form-control">
                                            <span class="msg font-11"
                                                *ngIf="(confirmpw.touched && confirmpw.errors)||(mdp.touched && mdp.errors) || (confirmpw.touched && mdp.touched && confirmpw.value != mdp.value)">mot
                                                de passe incompatibles*</span>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>Sexe</label>
                                                <div class="custom-controls-inline">
                                                    <label class="custom-control custom-radio">
                                                        <input (click)="checkGender('homme')" name="custom-radio-3"
                                                            type="radio" class="custom-control-input" checked>
                                                        <span class="custom-control-label">Homme</span>
                                                    </label>
                                                    <label class="custom-control custom-radio">
                                                        <input (click)="checkGender('femme')" name="custom-radio-3"
                                                            type="radio" class="custom-control-input">
                                                        <span class="custom-control-label">Femme</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>Role</label>
                                                <select #role="ngModel" required [(ngModel)]="userToAdd.role"
                                                    name="role" class="form-control mb-3">
                                                    <option selected value="Role">Role</option>
                                                    <option value="admin">Administrateur</option>
                                                    <option value="delege">Délegué / Animatrice</option>
                                                </select>
                                                <span class="msg font-11"
                                                    *ngIf="role.touched && role.value === 'Role'">Role non
                                                    choisit</span>
                                            </div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>N° Tel personnel</label>
                                                <input #telp="ngModel" required minlength="6" maxlength="20"
                                                    [(ngModel)]="userToAdd.telephone_perso" name='telp' type="number"
                                                    class="form-control" placeholder="+216 XXX XX XX">
                                                <span class="msg font-11" *ngIf="telp.touched && telp.errors">Numéro
                                                    invalide*</span>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>N° Tel attribué</label>
                                                <input #tela="ngModel" [(ngModel)]="userToAdd.telephone" name="tel"
                                                    type="number" class="form-control" placeholder="+216 XXX XX XX">
                                                <span class="msg font-11" *ngIf="tela.touched && tela.errors">Numéro
                                                    invalide*</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>etat du compte </label>
                                            <div class="custom-control custom-switch">
                                                <input #enabled="ngModel" [(ngModel)]="userToAdd.isActivated"
                                                    name="etat" type="checkbox" class="custom-control-input"
                                                    id="customSwitch1">
                                                <label class="custom-control-label"
                                                    for="customSwitch1">{{enabled.value == true ? 'activé' : 'desactivé'}}
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>A propos</label>
                                            <textarea [(ngModel)]="userToAdd.about" name="abt" class="form-control"
                                                placeholder="Vos remarques, ou autres informations içi..."
                                                rows="3"></textarea>
                                        </div>
                                        <div class="form-row mt-3 float-right">
                                            <div class="">
                                                <button type="submit" [disabled]="userForm.invalid" (click)="submit(userForm)"
                                                    class="btn btn-primary btn-lg ">Enregistrer</button>
                                                <button type="reset" class="btn btn-danger btn-lg ml-2">Réinitialiser</button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                              
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <app-admin-users-edit *ngIf="editableUser" [targetUser]="editableUser"></app-admin-users-edit>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Liste des utilisateurs</h5>
                            <h6 class="card-subtitle text-muted">délegués, administrateurs et superviseurs enregistrés
                                <ul>
                                    <li>(A) : attribué</li>
                                    <li>(P) : personnel</li>
                                </ul>
                            </h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped table-bordered " [dtTrigger]="usersTrigger" datatable
                                [dtOptions]="dtOptions">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>role</th>
                                        <th>Nom Complet</th>
                                        <th>Emails</th>
                                        <th>N° telephone</th>
                                        <th>etat du compte</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let user of data">
                                        <td>
                                            <img [src]="user.imageUrl ? user.imageUrl : 'assets/img/avatars/avatar.jpg'" width="48" height="48" class="rounded-circle mr-2" alt="Avatar">
                                        </td>
                                        <td class="text-center"><span
                                                [ngClass]="roleClass(user.role)">{{user.role}}</span></td>
                                        <td>{{user.nom}} {{user.prenom}}</td>
                                        <td><span *ngIf="user.email">(A){{user.email}}</span><span
                                                *ngIf="user.emailPerso"><br>(P){{user.emailPerso}}</span></td>
                                        <td><span *ngIf="user.telephone">(A){{user.telephone}}</span> <span
                                                *ngIf="user.telephone_perso"> <br /> (P){{user.telephone_perso}}</span>
                                        </td>
                                        <td class="text-center"><span
                                                [ngClass]="etatCompte(user.isActivated)">{{user.isActivated == true ? 'activé' : 'desactivé'}}</span>
                                            <span [ngClass]="online(user.status)">{{user.status}}</span></td>
                                        <td class="text-center"><button (click)="setEditableUser(user)" class="btn btn-pill btn-primary"><i
                                                    class="fas fa-info"></i></button>
                                                    <button class="btn btn-pill btn-danger ml-2" data-toggle="modal" (click)="selectedUser = user"
                                                data-target="#sizedModalSm"><i class="fas fa-times"></i></button>

                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>


</div>
<app-small-modal [titre]="message" [contenu]="contenu"></app-small-modal>
<div class="modal fade" id="sizedModalSm" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Supprimer l'utilisateur</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body m-3">
                <p class="mb-0">Etes vous sûr(e) de vouloir supprimer {{selectedUser.prenom}} {{selectedUser.nom}} qui est un(e) {{selectedUser.sexe == 'homme' ? 'délégué' : 'animatrice'}}.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">annuler</button>
                <button type="button"  (click)="deleteUser()" class="btn btn-danger">supprimer</button>
            </div>
        </div>
    </div>
</div>
<!-- END  modal -->